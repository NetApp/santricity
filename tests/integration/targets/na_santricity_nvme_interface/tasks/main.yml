# Test code for the na_santricity_nvme_interface module
# (c) 2018, NetApp, Inc
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Set facts for na_santricity_nvme_interface module test
  set_fact:
    vars:
      credentials: &creds
        ssid: "{{ ssid }}"
        api_url: "{{ base_url }}"
        api_username: "{{ username }}"
        api_password: "{{ password }}"
        validate_certs: "{{ validate_cert }}"
      interface_a1_ip: &a1_ip 192.168.3.100
      interface_a2_ip: &a2_ip 192.168.3.101

- name: Set the initial nvme interfaces
  na_santricity_nvme_interface:
    <<: *creds
    controller: "{{ item[0] }}"
    channel: "{{ item[1] }}"
    address: "{{ item[2] }}"
  loop:
    - ["A", "1", *a1_ip]
    - ["B", "1", *a2_ip]

- name: Repeat the initial nvme interfaces (no change)
  na_santricity_nvme_interface:
    <<: *creds
    controller: "{{ item[0] }}"
    channel: "{{ item[1] }}"
    address: "{{ item[2] }}"
  register: results
  loop:
    - ["A", "1", *a1_ip]
    - ["B", "1", *a2_ip]
- name: Verify no changes were made
  assert:
    that: "{{ not item['changed'] }}"
    msg: "Unexpected results!"
  loop: "{{ lookup('list', results['results']) }}"

- name: Change the initial nvme interfaces (changed, check_mode)
  na_santricity_nvme_interface:
    <<: *creds
    controller: "{{ item[0] }}"
    channel: "{{ item[1] }}"
    address: "{{ item[2] }}"
  register: results
  loop:
    - ["A", "1", "192.168.3.230"]
    - ["B", "1", "192.168.3.231"]
  check_mode: true
- name: Verify no changes were made
  assert:
    that: "{{ item['changed'] }}"
    msg: "Unexpected results!"
  loop: "{{ lookup('list', results['results']) }}"

- name: Change the initial nvme interfaces (changed)
  na_santricity_nvme_interface:
    <<: *creds
    controller: "{{ item[0] }}"
    channel: "{{ item[1] }}"
    address: "{{ item[2] }}"
  register: results
  loop:
    - ["A", "1", "192.168.3.230"]
    - ["B", "1", "192.168.3.231"]
- name: Verify no changes were made
  assert:
    that: "{{ item['changed'] }}"
    msg: "Unexpected results!"
  loop: "{{ lookup('list', results['results']) }}"

- name: Revert to the initial nvme interfaces (changed)
  na_santricity_nvme_interface:
    <<: *creds
    controller: "{{ item[0] }}"
    channel: "{{ item[1] }}"
    address: "{{ item[2] }}"
  register: results
  loop:
    - ["A", "1", *a1_ip]
    - ["B", "1", *a2_ip]
- name: Verify no changes were made
  assert:
    that: "{{ item['changed'] }}"
    msg: "Unexpected results!"
  loop: "{{ lookup('list', results['results']) }}"