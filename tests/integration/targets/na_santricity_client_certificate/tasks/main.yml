# Test code for the na_santricity_alerts module
# (c) 2018, NetApp, Inc
# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)

- name: Set credential facts
  set_fact:
    credentials: &creds
      ssid: "{{ ssid }}"
      api_url: "{{ base_url }}"
      api_username: "{{ username }}"
      api_password: "{{ password }}"
      validate_certs: "{{ validate_cert }}"

- name: Remove certificates
  na_santricity_client_certificate:
    <<: *creds

- name: Upload certificate (changed, check_mode)
  na_santricity_client_certificate:
    <<: *creds
    certificates:
      - "/home/swartzn/NetApp Corp Root CA.crt"
      - "/home/swartzn/NetApp Corp Issuing CA 1.crt"
      - "/home/swartzn/swartzn-Nathan-Swartz.crt"
  register: result
  check_mode: true
- assert:
    that: "{{ result['changed'] }}"
    msg: "Failed to upload certificates to storage array."

- name: Upload certificate (changed)
  na_santricity_client_certificate:
    <<: *creds
    certificates:
      - "/home/swartzn/NetApp Corp Root CA.crt"
      - "/home/swartzn/NetApp Corp Issuing CA 1.crt"
      - "/home/swartzn/swartzn-Nathan-Swartz.crt"
  register: result
- assert:
    that: "{{ result['changed'] }}"
    msg: "Failed to upload certificates to storage array."

- name: Repeat upload certificate (no change)
  na_santricity_client_certificate:
    <<: *creds
    certificates:
      - "/home/swartzn/NetApp Corp Root CA.crt"
      - "/home/swartzn/NetApp Corp Issuing CA 1.crt"
      - "/home/swartzn/swartzn-Nathan-Swartz.crt"
  register: result
- assert:
    that: "{{ not result['changed'] }}"
    msg: "Failed not to make any changes."

- name: Remove certificates
  na_santricity_client_certificate:
    <<: *creds
  register: result
- assert:
    that: "{{ result['changed'] }}"
    msg: "Failed to remove uploaded certificates"