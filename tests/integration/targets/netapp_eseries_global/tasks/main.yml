- set_facts:
  ssid: &id "1"
  base_url: &url https://196.168.1.1:8443/devmgr/v2/
  username: &user admin
  password: &pass adminpass
  validate_cert: &verify false
  array_credentials: &array_creds
    ssid: *id
    api_url: *url
    api_username: *user
    api_password: *pass
    validate_certs: *verify
  uri_credentials: &uri_array_creds
    user: *user
    password: *pass
    validate_certs: *verify

- name: Set initial global settings
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    name: arrayname01
    cache_block_size: 32768
    cache_flush_threshold: 80
    automatic_load_balancing: disabled
    host_connectivity_reporting: disabled
    default_host_type: linux dm-mp
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname01' and
              graph['json'][0]['cache']['cacheBlkSize'] == 32768 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 80 and
              not graph['json'][0]['autoLoadBalancingEnabled'] and
              not graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 28 }}"
    msg: "Failed to set initial global settings"

- name: Repeat initial global settings
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    name: arrayname01
    cache_block_size: 32768
    cache_flush_threshold: 80
    automatic_load_balancing: disabled
    host_connectivity_reporting: disabled
    default_host_type: linux dm-mp
  register: result
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ not result.changed and
              graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname01' and
              graph['json'][0]['cache']['cacheBlkSize'] == 32768 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 80 and
              not graph['json'][0]['autoLoadBalancingEnabled'] and
              not graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 28 }}"
    msg: "Failed to set initial global settings"

- name: Change global settings (check-mode)
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    name: arrayname02
    cache_block_size: 8192
    cache_flush_threshold: 60
    automatic_load_balancing: disabled
    host_connectivity_reporting: disabled
    default_host_type: windows
  check_mode: true
  register: result
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ result.changed and
              graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname01' and
              graph['json'][0]['cache']['cacheBlkSize'] == 32768 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 80 and
              not graph['json'][0]['autoLoadBalancingEnabled'] and
              not graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 28 }}"
    msg: "Failed to set initial global settings"

- name: Change global settings
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    name: arrayname02
    cache_block_size: 8192
    cache_flush_threshold: 60
    automatic_load_balancing: disabled
    host_connectivity_reporting: disabled
    default_host_type: windows
  register: result
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ result.changed and
              graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname02' and
              graph['json'][0]['cache']['cacheBlkSize'] == 8192 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 60 and
              not graph['json'][0]['autoLoadBalancingEnabled'] and
              not graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 1 }}"
    msg: "Failed to set initial global settings"

- name: Turn on autoload balancing which should force enable host connection reporting
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    automatic_load_balancing: enabled
  register: result
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ result.changed and
              graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname02' and
              graph['json'][0]['cache']['cacheBlkSize'] == 8192 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 60 and
              graph['json'][0]['autoLoadBalancingEnabled'] and
              graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 1 }}"
    msg: "Failed to set initial global settings"

- name: Change array name only
  netapp_eseries.santricity.nac_santricity_global:
    <<: *array_creds
    name: arrayname03
  register: result
- name: Retrieve the current array graph
  uri:
    <<: *uri_array_creds
    url: "{{ base_url }}storage-systems/{{ ssid }}/graph/xpath-filter?query=/sa"
  register: graph
- name: Validate initial global settings
  assert:
    that: "{{ result.changed and
              graph['json'][0]['saData']['storageArrayLabel'] == 'arrayname03' and
              graph['json'][0]['cache']['cacheBlkSize'] == 8192 and
              graph['json'][0]['cache']['demandFlushThreshold'] == 60 and
              graph['json'][0]['autoLoadBalancingEnabled'] and
              graph['json'][0]['hostConnectivityReportingEnabled'] and
              graph['json'][0]['defaultHostTypeIndex'] == 1 }}"
    msg: "Failed to set initial global settings"
